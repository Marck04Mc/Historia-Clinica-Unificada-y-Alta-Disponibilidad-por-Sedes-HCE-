{% extends "base.html" %}

{% block title %}Cambiar Contraseña - Sistema HCE{% endblock %}

{% block content %}
<div class="container">
    <div class="change-password-container">
        <div class="card">
            <div class="card-header">
                <h3>Cambiar Contraseña</h3>
            </div>
            <div class="card-body">
                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <div id="successMessage" class="success-message" style="display: none;"></div>

                <form id="changePasswordForm">
                    <div class="form-group">
                        <label>Contraseña Actual</label>
                        <input type="password" name="current_password" id="currentPassword" required>
                    </div>

                    <div class="form-group">
                        <label>Nueva Contraseña</label>
                        <input type="password" name="new_password" id="newPassword" required minlength="8">
                        <div class="password-requirements">
                            <p><strong>La contraseña debe contener:</strong></p>
                            <ul>
                                <li id="req-length">Mínimo 8 caracteres</li>
                                <li id="req-uppercase">Al menos una letra mayúscula</li>
                                <li id="req-lowercase">Al menos una letra minúscula</li>
                                <li id="req-number">Al menos un número</li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Confirmar Nueva Contraseña</label>
                        <input type="password" name="confirm_password" id="confirmPassword" required>
                        <small id="passwordMatch" style="display: none;"></small>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-block">Cambiar Contraseña</button>
                        <button type="button" onclick="goBack()" class="btn btn-secondary btn-block">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const newPasswordInput = document.getElementById('newPassword');
    const confirmPasswordInput = document.getElementById('confirmPassword');
    const passwordMatchMsg = document.getElementById('passwordMatch');

    // Validación en tiempo real de requisitos de contraseña
    newPasswordInput.addEventListener('input', function () {
        const password = this.value;

        // Validar longitud
        const lengthReq = document.getElementById('req-length');
        if (password.length >= 8) {
            lengthReq.style.color = 'green';
            lengthReq.innerHTML = '✓ Mínimo 8 caracteres';
        } else {
            lengthReq.style.color = 'red';
            lengthReq.innerHTML = '✗ Mínimo 8 caracteres';
        }

        // Validar mayúscula
        const uppercaseReq = document.getElementById('req-uppercase');
        if (/[A-Z]/.test(password)) {
            uppercaseReq.style.color = 'green';
            uppercaseReq.innerHTML = '✓ Al menos una letra mayúscula';
        } else {
            uppercaseReq.style.color = 'red';
            uppercaseReq.innerHTML = '✗ Al menos una letra mayúscula';
        }

        // Validar minúscula
        const lowercaseReq = document.getElementById('req-lowercase');
        if (/[a-z]/.test(password)) {
            lowercaseReq.style.color = 'green';
            lowercaseReq.innerHTML = '✓ Al menos una letra minúscula';
        } else {
            lowercaseReq.style.color = 'red';
            lowercaseReq.innerHTML = '✗ Al menos una letra minúscula';
        }

        // Validar número
        const numberReq = document.getElementById('req-number');
        if (/[0-9]/.test(password)) {
            numberReq.style.color = 'green';
            numberReq.innerHTML = '✓ Al menos un número';
        } else {
            numberReq.style.color = 'red';
            numberReq.innerHTML = '✗ Al menos un número';
        }

        checkPasswordMatch();
    });

    // Validar que las contraseñas coincidan
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);

    function checkPasswordMatch() {
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;

        if (confirmPassword.length > 0) {
            passwordMatchMsg.style.display = 'block';
            if (newPassword === confirmPassword) {
                passwordMatchMsg.style.color = 'green';
                passwordMatchMsg.textContent = '✓ Las contraseñas coinciden';
            } else {
                passwordMatchMsg.style.color = 'red';
                passwordMatchMsg.textContent = '✗ Las contraseñas no coinciden';
            }
        } else {
            passwordMatchMsg.style.display = 'none';
        }
    }

    // Validar fortaleza de contraseña
    function validatePassword(password) {
        const minLength = password.length >= 8;
        const hasUppercase = /[A-Z]/.test(password);
        const hasLowercase = /[a-z]/.test(password);
        const hasNumber = /[0-9]/.test(password);

        return minLength && hasUppercase && hasLowercase && hasNumber;
    }

    // Manejar envío del formulario
    document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        const errorMsg = document.getElementById('errorMessage');
        const successMsg = document.getElementById('successMessage');

        errorMsg.style.display = 'none';
        successMsg.style.display = 'none';

        // Validar que las contraseñas coincidan
        if (newPassword !== confirmPassword) {
            errorMsg.textContent = 'Las contraseñas no coinciden';
            errorMsg.style.display = 'block';
            return;
        }

        // Validar fortaleza de la contraseña
        if (!validatePassword(newPassword)) {
            errorMsg.textContent = 'La contraseña no cumple con los requisitos de seguridad';
            errorMsg.style.display = 'block';
            return;
        }

        try {
            const token = localStorage.getItem('token');
            const response = await fetch('/auth/change-password', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.detail || 'Error al cambiar la contraseña');
            }

            successMsg.textContent = '✓ Contraseña cambiada exitosamente. Redirigiendo...';
            successMsg.style.display = 'block';

            // Redirigir después de 2 segundos
            setTimeout(() => {
                goBack();
            }, 2000);

        } catch (error) {
            errorMsg.textContent = error.message;
            errorMsg.style.display = 'block';
        }
    });

    function goBack() {
        window.history.back();
    }
</script>

<style>
    .change-password-container {
        max-width: 500px;
        margin: 2rem auto;
    }

    .password-requirements {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 0.5rem;
        font-size: 0.9rem;
    }

    .password-requirements p {
        margin: 0 0 0.5rem 0;
        font-weight: 600;
    }

    .password-requirements ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .password-requirements li {
        padding: 0.25rem 0;
        transition: color 0.2s;
    }

    .success-message {
        background-color: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid #c3e6cb;
    }
</style>
{% endblock %}