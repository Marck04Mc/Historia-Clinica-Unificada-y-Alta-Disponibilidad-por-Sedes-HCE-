apiVersion: v1
kind: ConfigMap
metadata:
  name: hce-db-schema
data:
  01-schema.sql: |
    -- =============================================
    -- Schema para Sistema HCE (Monolítico / Microservicios)
    -- =============================================

    -- Tabla de Sedes (Clínicas)
    CREATE TABLE IF NOT EXISTS sedes (
        id_sede SERIAL PRIMARY KEY,
        nombre VARCHAR(100) NOT NULL,
        ciudad VARCHAR(100) NOT NULL,
        direccion VARCHAR(200),
        telefono VARCHAR(20),
        email VARCHAR(100),
        activo BOOLEAN DEFAULT TRUE
    );

    -- Tabla de Usuarios (RBAC Simplificado)
    CREATE TABLE IF NOT EXISTS usuarios (
        id_usuario SERIAL PRIMARY KEY,
        username VARCHAR(50) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        rol VARCHAR(20) NOT NULL,
        id_sede INTEGER REFERENCES sedes(id_sede),
        nombres VARCHAR(100),
        apellidos VARCHAR(100),
        email VARCHAR(100) UNIQUE,
        activo BOOLEAN DEFAULT TRUE,
        CONSTRAINT usuarios_rol_check CHECK (rol IN ('paciente', 'admisionista', 'medico', 'historificacion', 'admin'))
    );

    -- Tabla de Pacientes
    CREATE TABLE IF NOT EXISTS pacientes (
        id_paciente SERIAL PRIMARY KEY,
        identificacion VARCHAR(20) UNIQUE NOT NULL,
        tipo_identificacion VARCHAR(10) NOT NULL,
        nombres VARCHAR(100) NOT NULL,
        apellidos VARCHAR(100) NOT NULL,
        fecha_nacimiento DATE NOT NULL,
        genero VARCHAR(10) NOT NULL,
        telefono VARCHAR(20),
        email VARCHAR(100),
        direccion VARCHAR(200),
        ciudad VARCHAR(100),
        id_usuario INTEGER REFERENCES usuarios(id_usuario),
        fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        activo BOOLEAN DEFAULT TRUE
    );

    -- Tabla de Encuentros Clínicos (Consultas)
    CREATE TABLE IF NOT EXISTS encuentros_clinicos (
        id_encuentro SERIAL PRIMARY KEY,
        id_paciente INTEGER REFERENCES pacientes(id_paciente),
        id_sede INTEGER REFERENCES sedes(id_sede),
        id_doctor INTEGER REFERENCES usuarios(id_usuario),
        fecha_hora TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        tipo_encuentro VARCHAR(50) NOT NULL, -- consulta, urgencia, control
        motivo_consulta TEXT,
        notas_clinicas TEXT,
        estado VARCHAR(20) DEFAULT 'finalizado'
    );

    -- Tabla de Observaciones Clínicas (Signos Vitales, Medidas)
    CREATE TABLE IF NOT EXISTS observaciones_clinicas (
        id_observacion SERIAL PRIMARY KEY,
        id_encuentro INTEGER REFERENCES encuentros_clinicos(id_encuentro),
        id_paciente INTEGER REFERENCES pacientes(id_paciente),
        codigo_loinc VARCHAR(20),
        descripcion VARCHAR(200) NOT NULL,
        valor_numerico DECIMAL(10, 2),
        valor_texto VARCHAR(200),
        unidad VARCHAR(20),
        rango_referencia VARCHAR(50),
        interpretacion VARCHAR(50),
        fecha_hora TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Tabla de Diagnósticos (CIE-10 / SNOMED)
    CREATE TABLE IF NOT EXISTS diagnosticos (
        id_diagnostico SERIAL PRIMARY KEY,
        id_encuentro INTEGER REFERENCES encuentros_clinicos(id_encuentro),
        id_paciente INTEGER REFERENCES pacientes(id_paciente),
        codigo_icd10 VARCHAR(20),
        codigo_snomed VARCHAR(20),
        descripcion VARCHAR(255) NOT NULL,
        tipo VARCHAR(50), -- principal, secundario
        estado VARCHAR(20) DEFAULT 'activo',
        fecha_diagnostico TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    );

    -- Tabla de Medicamentos (Prescripciones)
    CREATE TABLE IF NOT EXISTS medicamentos (
        id_medicamento SERIAL PRIMARY KEY,
        id_encuentro INTEGER REFERENCES encuentros_clinicos(id_encuentro),
        id_paciente INTEGER REFERENCES pacientes(id_paciente),
        nombre VARCHAR(100) NOT NULL,
        principio_activo VARCHAR(100),
        dosis VARCHAR(50),
        frecuencia VARCHAR(50),
        duracion VARCHAR(50),
        via_administracion VARCHAR(50),
        indicaciones TEXT,
        fecha_prescripcion TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        estado VARCHAR(20) DEFAULT 'activo'
    );

    -- Insertar Sedes de Prueba
    INSERT INTO sedes (nombre, ciudad, direccion, telefono, email) VALUES
    ('Clínica Central', 'Bogotá', 'Av. Caracas # 45-67', '601-1234567', 'contacto@central.hce.com'),
    ('Hospital del Norte', 'Medellín', 'Calle 10 # 20-30', '604-7654321', 'info@norte.hce.com'),
    ('Centro Médico Sur', 'Cali', 'Carrera 5 # 66-77', '602-9876543', 'atencion@sur.hce.com')
    ON CONFLICT DO NOTHING;
